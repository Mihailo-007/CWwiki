import React, { useState } from "react";
import { View, Text, StyleSheet, ScrollView, TouchableOpacity, Image } from "react-native";
import { getBattleSummary } from "../api/ollama";

export default function BattleScreen({ route }: any) {
  const { id } = route.params;

  const [summary, setSummary] = useState("");
  const [loading, setLoading] = useState(false);

  const battles: any = {
    umbara: {
      title: "Битва за Умбару",
      shortDescription:
        "Масштабна та трагічна битва під час Війн клонів, де 501-й легіон стикається зі зрадою генерала Понга Крелла.",

      images: {
        main: require("../../assets/umbara/umbara.jpg")
      },

      description: `
Причини:
Битва за Умбару стала одним із найбільш суперечливих та трагічних етапів Війн клонів. Планета, відома своїми передовими технологіями й ізольованою культурою, заявила про вихід з Республіки після загибелі свого сенатора Мі Дічі. Відмова умбарців співпрацювати з Галактичною Республікою дала змогу КНС відкрити на планеті стратегічні виробничі лінії та розмістити флот. Умбарці мали власні унікальні військові машини, які були небачено ефективними в умовах туману й фауни планети, що створювало колосальні ризики. Республіка не могла дозволити противнику зміцнитися у такому важливому секторі, особливо коли війна почала перетворюватися на змагання за контроль над ключовими логістичними вузлами.

Передумови:
На початку операції Умбару атакували відразу кілька підрозділів Республіки. Головний удар припадав на 501-й легіон під командуванням Енакіна Скайвокера. Завдяки його агресивним, але результативним тактикам клони швидко прорвали першу оборонну лінію умбарців та закріпилися на плацдармі. Однак раптове повідомлення з Корусанту відкликало Скайвокера й позбавило легіон його традиційного лідера. На його місце був призначений генерал Понг Крелл - джедай, відомий високими втратами в своїх кампаніях та репутацією холодного стратега, який майже не зважав на життя солдатів. Саме з цього моменту ситуація для 501-го стала катастрофічно погіршуватися.

Хід битви:
Отримавши командування, Крелл повністю змінив підхід до боїв. Він заборонив тактичні маневри, диверсії, розвідку та флангові атаки - натомість наказав проводити масові лобові штурми на укріплені позиції. Умбарські танки, літаючі інтерцептори та живі пастки планети знищували ряди клонів десятками. Проте найбільше солдатів вражала не небезпека ворога, а байдужість власного генерала.

Завданням легіону став захват авіабази - головного вузла поставок ворога. Під час операції Файвз і Хардкейс запропонували план використання захоплених умбарських винищувачів для атаки орбітального корабля постачання КНС. Крелл категорично заборонив ініціативу, але клони, розуміючи стратегічну необхідність, порушили наказ. Результат - успішне знищення корабля і загибель Хардкейса.

Після цього 501-й почав підозрювати, що Крелл свідомо веде їх на смерть. Пік абсурду настав, коли генерал подав фальшиві дані, через які 501-й та 212-й легіони прийняли один одного за переодягнених умбарців. Бій між двома республіканськими підрозділами призвів до численних смертей, серед них - Ваксер. Це стало остаточним переломним моментом.

Ключові моменти:
- саботаж Крелла та спроба використати клони як інструмент власного переходу до КНС;
- самовільна, але успішна диверсія Файвза, Хардкейса та Джессі;
- бій між 501-м і 212-м через маніпуляції генерала;
- переслідування Крелла в джунглях і його арешт;
- страта генерала Догмою за державну зраду - одна з небагатьох смертей джедая від руки клона.

Наслідки:
Битва завершилась формальною перемогою Республіки, але моральним розгромом 501-го легіону. Солдати побачили, що навіть джедай може зрадити. Після Умбари багато клонів почали сумніватися в Ордені, а Рекс отримав один із найтяжчих досвідів у своїй службі. Психологічний шрам битви залишився на всій 501-й.
`,

      characters: [
        "Капітан Рекс",
        "Файвз",
        "Хардкейс",
        "Джессі",
        "Кікс",
        "Тап",
        "Догма",
        "Аппо",
        "Ваксер",
        "Генерал Понг Крелл",
        "Енакін Скайвокер",
        "Обі-Ван Кенобі"
      ]
    },

    geonosis2: {
      title: "Друга битва за Джеонозис",
      shortDescription: "Масштабна операція Республіки для знищення фабрик бойових дроїдів.",

      images: {
        main: require("../../assets/geonosis/geonosis.jpg")
      },

      description: `
Причини:
Після першої битви Республіка була впевнена, що Джеонозис більше не здатен виробляти дроїдів. Але діяльність Поггля Меншого довела протилежне. Через підземну мережу тунелів та езотеричних храмів геонозійці відновили виробництво, цього разу ще глибше та технологічніше, застосовуючи нові моделі супер-танків, автономні фабрики та біологічні технології. Це загрожувало стратегічній стабільності всієї Республіки - один лише Джеонозис міг забезпечувати КНС армією дроїдів швидше, ніж Республіка встигала їх знищувати.

Передумови:
Операція була масштабною: Ки-Аді-Мунді, Обі-Ван, Енакін, 212-й, 501-й, вуккі, винищувачі, артилерія. План Республіки передбачав одночасне знищення щитів, відбиття наземної оборони та зачистку підземних тунелів. Окремо Лумінара Ундули проводила власну місію - переслідування Поггля Меншого, який втік у стародавні геонозійські катакомби.

Хід битви:
Наступ тривав у кілька фаз. Спершу Республіка штурмувала укріплену гряду, звідки геонозійці застосовували артилерію, літаючі рої та кислотні бомби. Бій був виснажливим: піонерські батальйони втрачали цілі взводи через хижих жовтих геонозійців, що нападали з повітря.

Після прориву щитів розпочалася друга фаза - атака на фабрику. Асока та Баррісс спустилися у підземні тунелі, де стикнулися з пастками, кислотними резервуарами та загонами дроїдів TX-21. Втративши вибухівку, вони використали супер-танк сепаратистів, протаранили реактор і підірвали фабрику зсередини. Лише вчасне втручання Скайвокера врятувало їх від загибелі.

Третя фаза - полювання на Поггля. Лумінара потрапила в пастку зомбі-джеонозійців, яких контролювали паразити мозкові черви. Кенобі, Енакін і солдати провели операцію у катакомбах, пробиваючись через заражених воїнів, уникаючи паразитів та рятуючи Лумінару. У фіналі вони обвалили весь комплекс, поховавши під руїнами королеву Каріну Велику та частину її армії.

Ключові моменти:
- прорив оборони планети під щитами;
- вибух фабрики через використання супертанка;
- бій у тунелях з «зомбі-джеонозійцями»;
- падіння підземного храму;
- захоплення Поггля, однієї з ключових постатей КНС.

Наслідки:
Джеонозис було очищено від ключових заводів, але повністю знищити інфраструктуру не вдалося - згодом на планеті знову виникнуть комплекси. Битва стала однією з найважчих, показавши, наскільки небезпечними можуть бути біотехнології геонозійців. Для клонів це був один із найбільш виснажливих етапів війни.
`,

      characters: [
        "Капітан Коді",
        "Командер Вульф",
        "Боіл",
        "Ґосс",
        "Кі-Аді-Мунді",
        "Енакін Скайвокер",
        "Асока Тано",
        "Обі-Ван Кенобі",
        "Лумінара Ундула",
        "Баррісс Оффі",
        "Поггль Менший"
      ]
    },

    kashyyyk: {
      title: "Оборона Кашиику",
      shortDescription:
        "Одна з фінальних битв Війн клонів, де вуккі та клони спільно обороняли рідну планету від вторгнення сепаратистів.",

      images: {
        main: require("../../assets/kashyyyk/kashyyyk.jpg")
      },

      description: `
Причини:
Кашиик був ключовим осередком знань навігації: вуккі зберігали мапи гіпермаршрутів. КНС не могла дозволити Республіці зберегти контроль над такою планетою. Крім того, трандошани, підтримувані сепаратистами, викрали й убили принца Рикуммі, що спровокувало війну між расами та втягнуло планету у конфлікт.

Передумови:
На планету спершу прибув загін «Дельта», який виявив ознаки масштабної підготовки вторгнення: вузли зв’язку КНС, склади бойових дроїдів та приховані бази трандошан. У відповідь Республіка скерувала 41-й елітний корпус на чолі з командером Грі. Йода прибув як високий командир операції, оскільки мав давній зв’язок із вуккі та їхніми кланами. До оборони приєдналися Чубакка і Тарффулл.

Хід битви:
Основні бої розгорнулися на узбережжі Качиро, де клони побудували оборонні лінії, артилерійські вежі й систему прихованих укриттів. Дроїди КНС висаджувалися в кілька хвиль: танки NR-N99, павуки DSD1, десантні штурмові кораблі, та важкі роботизовані платформи.

Вуккі вели війну з моря, використовуючи реактивні катамарани, обстрілюючи фланги ворога та змішуючи формування дроїдів. Йода координував атаку, використовуючи поєднання військових маневрів та точкових ударів джедаїв.

Клони утримували дамбу, заводи та мости, щоб не допустити прориву важкої техніки КНС. Частина республіканських сил проводила операції в джунглях проти розвідувальних груп дроїдів і трандошанських мисливців.

Під час кульмінації битви командер Грі отримав Приказ 66. Його спроба вбити Йоду стала блискавичною, але джедай обеззброїв і вбив обох клонів. Після цього Йода був змушений тікати, а Кашиик фактично потрапив під контроль майбутньої Імперії.

Ключові моменти:
- оборона Качиро, епічні морські бої вуккі;
- підрив мостів і контратаки вуккі;
- спроба убивства Йоди клонами;
- повний контроль Республіки, який у ту ж мить перетворився на окупацію Імперії.

Наслідки:
Незважаючи на тактичну перемогу проти дроїдів, у стратегічному сенсі Кашиик програв. Вуккі були поневолені Імперією, а джунглі планети перетворилися на трудові табори. Для Йоди битва стала останнім боєм перед вигнанням. Кашиик - один із найтрагічніших фіналів війни.
`,

      characters: [
        "Коммандер Грі",
        "Майстер Йода",
        "Лумінара Ундули",
        "Квінлан Вос",
        "Тарффулл",
        "Чубакка",
        "Загін 'Дельта'"
      ]
    },

    coruscant: {
      title: "Битва за Корусант",
      shortDescription:
        "Кульмінаційна битва початку 'Помсти ситхів' - вторгнення КНС у серце Республіки та визволення Палпатина.",

      images: {
        main: require("../../assets/coruscant/coruscant.jpg")
      },

      description: `
Причини:
Битва за Корусант стала кульмінацією Війн клонів. Поки Республіка билася у Внешньому Кільці, столиця залишилася без належної оборони. Сідіус навмисно послабив захист, передавши Грівусу секретні гіпермаршрути, що дозволило флоту КНС раптово атакувати.

Передумови:
Щоб відвернути джедаїв від пошуків Сідіуса й змусити Енакіна емоційно прив’язатися до нього, Палпатин спланував інсценоване викрадення. Після першого удару значну частину оборони столиці було знищено.

Хід битви:
Флот КНС з’явився прямо над мегаполісом. Дроди-стерв’ятники атакували вулиці, урядові будівлі, посадкові платформи. Десантні кораблі висаджували тисячі дроїдів.

Грівус зі своїми магнастражами захопив Палпатина і доставив його на флагман “Незрима длань”.

На орбіті розгорнулася одна з найбільших космічних битв епохи. Винищувачі 501-го прикривали крейсери Республіки, а клони-коммандос захищали міські сектори.

Оби-Ван та Енакін прорвалися на флагман. Після штурму вони знайшли Палпатина та вступили в бій з графом Дуку. Кенобі був виведений з бою, а Енакін, піддавшись емоціям та впливу Палпатина, обезголовив Дуку.

Після втечі Грівуса “Незрима длань” почала падати. Енакін здійснив аварійну посадку гігантського корабля на Корусанті.

Ключові моменти:
- Масована атака КНС на столицю.
- Інсценоване викрадення Палпатина.
- Одна з найбільших космічних битв у війні.
- Дуель Енакіна проти Дуку.
- Героїчна аварійна посадка.
- Фокс та Корусантська гвардія стримували дроїдів у центральних секторах.

Наслідки:
Палпатина врятовано, флот КНС розбитий, але перемога стала пасткою: смерть Дуку відчинила шлях для падіння Енакіна. Через кілька днів буде виконано Приказ 66. Корусант зазнав величезних руйнувань, багато секторів не відновили навіть після війни. Битва стала прологом до падіння Республіки.
`,

      characters: [
        "Енакін Скайвокер",
        "Оби-Ван Кенобі",
        "Палпатін - Дарт Сідіус",
        "Генерал Грівус",
        "Граф Дуку",
        "Мейс Вінду",
        "Йода",
        "Шаак Ті",
        "Командер Фокс",
        "501-й легіон",
        "Корусантська гвардія",
        "Клон-коммандос «Омега» та інші"
      ]
    }
  };

  const battle = battles[id];

  return (
    <ScrollView style={styles.container}>
      {battle.images.main && (
        <Image
          source={battle.images.main}
          style={styles.mainImage}
          resizeMode="cover"
        />
      )}

      <Text style={styles.title}>{battle.title}</Text>

      <Text style={styles.label}>Опис:</Text>
      <Text style={styles.text}>{battle.description}</Text>

      <Text style={styles.label}>Головні персонажі:</Text>
      {battle.characters.map((char: string, index: number) => (
        <Text key={index} style={styles.cloneItem}>• {char}</Text>
      ))}

      <TouchableOpacity
        style={styles.button}
        onPress={async () => {
          setSummary("");
          setLoading(true);

          const text = await getBattleSummary(battle.description);
          setSummary(text);

          setLoading(false);
        }}
      >
        <Text style={styles.buttonText}>Короткий переказ (ШІ)</Text>
      </TouchableOpacity>

      {loading && (
        <Text style={styles.loading}>Створення...</Text>
      )}

      {summary.length > 0 && (
        <View style={styles.summaryBox}>
          <Text style={styles.summaryText}>{summary}</Text>
        </View>
      )}
    </ScrollView>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: "#0f0f0f", padding: 16 },

  mainImage: {
    width: "100%",
    height: 230,
    borderRadius: 12,
    marginBottom: 16
  },

  title: { color: "#fff", fontSize: 26, fontWeight: "bold", marginBottom: 16 },

  label: { color: "#aaa", fontSize: 18, marginTop: 12, marginBottom: 4 },

  text: { color: "#eee", fontSize: 16, lineHeight: 22 },

  cloneItem: { color: "#fff", fontSize: 16, marginLeft: 8, marginVertical: 2 },

  button: { backgroundColor: "#2a72ff", padding: 14, borderRadius: 10, marginTop: 20 },

  buttonText: { color: "#fff", fontSize: 16, textAlign: "center", fontWeight: "bold" },

  loading: {
    color: "#7fa4ff",
    marginTop: 20,
    fontSize: 16,
    fontStyle: "italic",
    textAlign: "center"
  },

  summaryBox: {
    backgroundColor: "#1b1b1b",
    padding: 14,
    borderRadius: 10,
    marginTop: 20,
    borderWidth: 1,
    borderColor: "#2a72ff"
  },

  summaryText: {
    color: "#fff",
    fontSize: 16,
    lineHeight: 22
  }
});
